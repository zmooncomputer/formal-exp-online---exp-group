<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é—®å·å¡«å†™ - {{ topic_category }} (Aç»„)</title>
    <style>
        :root { --primary: #2980b9; --secondary: #2c3e50; --accent: #e67e22; --bg: #f5f6fa; --card-bg: #ffffff; }
        body { font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif; background-color: var(--bg); margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        #app { width: 90%; max-width: 800px; background: var(--card-bg); padding: 40px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); position: relative; z-index: 10; }
        #particleCanvas { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; pointer-events: none; z-index: 1; }
        .btn { padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; transition: all 0.2s; margin-top: 20px; font-weight: bold; }
        .btn-primary { background: var(--primary); color: white; }
        .scale-header { background: var(--primary); color: white; padding: 12px 20px; border-radius: 6px; margin-bottom: 25px; }
        .question-box { background: #f8f9fa; border-left: 5px solid var(--primary); padding: 20px; margin-bottom: 25px; }
        #barometerCanvas { width: 100%; height: 320px; margin-bottom: 10px; }
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .baro-feedback-container { display: flex; justify-content: space-between; align-items: center; gap: 15px; margin: 25px 0 15px 0; }
        .feedback-card { flex: 1; background: white; border-radius: 10px; padding: 15px; text-align: center; min-height: 80px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .card-predict { border: 2px solid #3498db; color: #2980b9; }
        .card-actual { border: 2px solid #e74c3c; color: #c0392b; }
        .card-label { font-size: 0.85em; color: #7f8c8d; margin-bottom: 8px; }
        .card-value { font-size: 1.6em; font-weight: bold; }
        .diff-box { display: flex; flex-direction: column; justify-content: center; align-items: center; min-width: 90px; }
        .diff-label { font-size: 0.75em; color: #95a5a6; }
        .diff-value { font-size: 1.2em; font-weight: bold; color: #7f8c8d; border-bottom: 2px solid #eee; }
        .eval-summary { text-align: center; color: #2c3e50; font-size: 1.1em; border-top: 1px solid #eee; padding-top: 15px; margin-top: 10px; }
        .radio-group label { display: block; padding: 12px; cursor: pointer; border: 1px solid #eee; margin-bottom: 5px; border-radius: 6px; }
        .radio-group label:hover { background: #f0f0f0; }
        .radio-group input[type="radio"] { margin-right: 10px; }
        .progress-info { text-align: center; color: #7f8c8d; margin-bottom: 20px; font-size: 0.9em; }
    </style>
</head>
<body>
<canvas id="particleCanvas"></canvas>
<div id="app">
    <div class="progress-info">
        <span>è¯é¢˜ {{ topic_idx + 1 }}/{{ total_topics }}: {{ topic_category }}</span> | 
        <span>{{ 'åè¯„ä¼°' if not is_pre else 'é¢„è¯„ä¼°' }}</span> (Aç»„)
    </div>
    
    <div id="view-question">
        <div id="q-header" class="scale-header"></div>
        <div class="question-box">
            <p id="q-prompt" style="color:#7f8c8d; font-size: 0.9em;"></p>
            <h3 id="q-text" style="margin:0;"></h3>
        </div>
        <div class="radio-group" id="q-options"></div>
        <div class="text-center"><button class="btn btn-primary" onclick="exp.submitAnswer()">ä¸‹ä¸€é¢˜</button></div>
    </div>

    <div id="view-barometer" class="hidden">
        <h2 id="baro-title" style="text-align:center; color: var(--primary); margin-bottom:10px;">ğŸ“ ä½ç½®å¯¹æ¯”</h2>
        <canvas id="barometerCanvas"></canvas>
        <div style="position:relative; height: 30px; margin-top: -10px;">
            <span id="baro-left" style="position:absolute; left:0; font-weight:bold; color:#7f8c8d;"></span>
            <span id="baro-right" style="position:absolute; right:0; font-weight:bold; color:#7f8c8d;"></span>
        </div>
        
        <div id="baro-slider-area" class="text-center" style="margin-top: 20px;">
            <p id="baro-instruction" style="color: var(--secondary); font-weight: bold; margin-bottom: 15px; padding: 0 10px; line-height: 1.5;">
                ç°åœ¨å±•ç¤ºçš„æ˜¯ä¸­å›½æ•´ä½“äººç¾¤çš„æ„è§åˆ†å¸ƒå›¾ï¼Œè¯·<span style="color: #e74c3c;">æ‹–åŠ¨åœ†ç‚¹</span>ï¼Œé¢„æµ‹ä½ è‡ªå·±åœ¨äººç¾¤ä¸­æ‰€å¤„çš„ä½ç½®ã€‚
            </p>
            <input type="range" id="baro-slider" style="width:100%" step="0.01" oninput="exp.updateBarometer(this.value)">
            <p>æ‚¨å½“å‰é¢„æµ‹ï¼šå…¨å›½å‰ <b id="baro-percentile" style="color:#e74c3c;"></b></p>
        </div>

        <div class="text-center">
            <button id="btn-baro-confirm" class="btn btn-primary" onclick="exp.handleBarometerConfirmation()" disabled style="opacity: 0.5; cursor: not-allowed;">ç¡®è®¤ä½ç½®</button>
        </div>
        
        <div id="baro-truth-feedback" class="hidden">
            <div class="baro-feedback-container">
                <div class="feedback-card card-predict">
                    <div class="card-label">æ‚¨çš„é¢„æµ‹ä½ç½®</div>
                    <div class="card-value">ç¬¬ <span id="predicted-pct"></span> ä½</div>
                </div>
                
                <div class="diff-box">
                    <div class="diff-label">åå·®å€¼</div>
                    <div id="pct-diff-value" class="diff-value"></div>
                </div>

                <div class="feedback-card card-actual">
                    <div class="card-label">æ‚¨çš„å®é™…ä½ç½®</div>
                    <div class="card-value">ç¬¬ <span id="actual-pct"></span> ä½</div>
                </div>
            </div>
            <div id="position-diff-text" class="eval-summary"></div>
        </div>

        <div class="text-center"><button id="btn-baro-confirm" class="btn btn-primary" onclick="exp.handleBarometerConfirmation()">ç¡®è®¤ä½ç½®</button></div>
    </div>
</div>

<script>
const DATA_LIB = {{ questionnaire_data | safe }};
const IS_PRE = {{ 'true' if is_pre else 'false' }};

const initParticles = () => {
    const canvas = document.getElementById('particleCanvas');
    const ctx = canvas.getContext('2d');
    let particles = [];
    const resize = () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; };
    window.addEventListener('resize', resize); resize();
    class Particle {
        constructor(x, y, color) { this.x = x; this.y = y; this.color = color; this.size = Math.random()*5+2; this.speedX = Math.random()*6-3; this.speedY = Math.random()*6-3; this.life = 1.0; }
        update() { this.x += this.speedX; this.y += this.speedY; this.life -= 0.02; }
        draw() { ctx.fillStyle = this.color; ctx.globalAlpha = Math.max(0, this.life); ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI*2); ctx.fill(); }
    }
    window.spawnParticles = (x, y, color) => { for(let i=0; i<15; i++) particles.push(new Particle(x, y, color)); };
    function animate() { ctx.clearRect(0,0,canvas.width,canvas.height); particles = particles.filter(p=>p.life>0); particles.forEach(p=>{p.update();p.draw();}); requestAnimationFrame(animate); }
    animate();
};
initParticles();

class Experiment {
    constructor(data) {
        this.data = data;
        this.scaleOrder = Object.keys(data).sort(() => Math.random() - 0.5);
        this.scaleIdx = 0; this.qIdx = 0; this.results = [];
        this.subjectId = "SUB_" + Math.floor(Date.now() / 1000);
        this.baroState = 'guessing'; 
        this.actualScore = 0; // å­˜å‚¨çœŸå®åˆ†æ•°
    }

    showView(id) { 
        document.querySelectorAll('#app > div').forEach(el => {
            if (el.id && el.id.startsWith('view-')) el.classList.add('hidden');
        }); 
        document.getElementById(id).classList.remove('hidden'); 
    }

    start() { this.showView('view-question'); this.renderQuestion(); }

    renderQuestion() {
        this.currentScaleName = this.scaleOrder[this.scaleIdx];
        const q = this.data[this.currentScaleName][this.qIdx];
        document.getElementById('q-header').innerText = `å½“å‰ç»´åº¦: ${this.currentScaleName} (${this.scaleIdx + 1}/${this.scaleOrder.length})`;
        document.getElementById('q-prompt').innerText = q.question_prompt;
        document.getElementById('q-text').innerText = q.text;
        const optContainer = document.getElementById('q-options');
        optContainer.innerHTML = '';
        q.options.forEach(opt => {
            const div = document.createElement('div');
            div.innerHTML = `<label><input type="radio" name="ans" value="${opt.value}"> ${opt.label}</label>`;
            optContainer.appendChild(div);
        });
    }

    submitAnswer() {
        const checked = document.querySelector('input[name="ans"]:checked');
        if(!checked) { alert("è¯·é€‰æ‹©ä¸€ä¸ªé€‰é¡¹"); return; }
        this.results.push({
            scale_name: this.currentScaleName, 
            question_id: this.data[this.currentScaleName][this.qIdx].id,
            personal_score: parseFloat(checked.value), 
            timestamp: new Date().toLocaleString()
        });

        if(this.qIdx < this.data[this.currentScaleName].length - 1) {
            this.qIdx++; this.renderQuestion();
        } else {
            if (!IS_PRE) {
                this.submitSurvey();
            } else {
                this.initBarometer();
            }
        }
    }

    initBarometer() {
        this.baroState = 'guessing';
        this.showView('view-barometer');
        const instruction = document.getElementById('baro-instruction');
        if(instruction) instruction.classList.remove('hidden');
        const btn = document.getElementById('btn-baro-confirm');
        btn.disabled = true;
        btn.style.opacity = "0.5";
        btn.style.cursor = "not-allowed";
        const qData = this.data[this.currentScaleName][0];
        this.currentEvalConfig = qData.eval_config;
        document.getElementById('baro-title').innerText = "ğŸ“ " + this.currentScaleName + " Â· ä½ç½®å¯¹æ¯”";
        document.getElementById('baro-left').innerText = qData.left_label;
        document.getElementById('baro-right').innerText = qData.right_label;
        document.getElementById('baro-slider-area').classList.remove('hidden');
        document.getElementById('baro-truth-feedback').classList.add('hidden');
        document.getElementById('btn-baro-confirm').innerText = "ç¡®è®¤ä½ç½®";
        
        const slider = document.getElementById('baro-slider');
        slider.min = qData.kde_data.min; slider.max = qData.kde_data.max; slider.value = qData.kde_data.mean;
        this.currentKDE = qData.kde_data;
        this.currentRawScores = qData.raw_scores;
        this.updateBarometer(slider.value);
    }

    getYOnCurve(x, kde) {
        if (x <= kde.x[0]) return kde.y[0];
        if (x >= kde.x[kde.x.length-1]) return kde.y[kde.y.length-1];
        for(let i=0; i < kde.x.length - 1; i++) {
            if(x >= kde.x[i] && x <= kde.x[i+1]) {
                const t = (x - kde.x[i]) / (kde.x[i+1] - kde.x[i]);
                return kde.y[i] + t * (kde.y[i+1] - kde.y[i]);
            }
        }
        return 0;
    }

    updateBarometer(val) {
        const canvas = document.getElementById('barometerCanvas');
        const ctx = canvas.getContext('2d');
        const w = canvas.width = canvas.offsetWidth;
        const h = canvas.height = canvas.offsetHeight;
        const pad = 60;
        const kde = this.currentKDE;
        const mapX = (v) => ((v - kde.min) / (kde.max - kde.min)) * (w - 2*pad) + pad;
        const maxY = Math.max(...kde.y);
        const mapY = (v) => h - pad - (v / maxY) * (h - 2*pad);

        ctx.clearRect(0,0,w,h);
        
        ctx.beginPath(); ctx.moveTo(mapX(kde.x[0]), mapY(kde.y[0]));
        for(let i=1; i<kde.x.length; i++) ctx.lineTo(mapX(kde.x[i]), mapY(kde.y[i]));
        ctx.strokeStyle = '#bdc3c7'; ctx.lineWidth = 3; ctx.stroke();
        ctx.fillStyle = 'rgba(189, 195, 199, 0.1)'; ctx.fill();

        const drawMarker = (xVal, color, label, labelBelow) => {
            const yVal = this.getYOnCurve(xVal, kde);
            const px = mapX(xVal); const py = mapY(yVal);
            ctx.beginPath(); ctx.setLineDash([5, 5]);
            ctx.moveTo(px, py); ctx.lineTo(px, h-pad);
            ctx.strokeStyle = color; ctx.lineWidth = 1.5; ctx.stroke();
            ctx.setLineDash([]);
            ctx.fillStyle = color; ctx.beginPath(); ctx.arc(px, py, 7, 0, Math.PI*2); ctx.fill();
            ctx.strokeStyle = '#fff'; ctx.lineWidth = 2; ctx.stroke();
            ctx.font = "bold 14px Microsoft YaHei";
            ctx.textAlign = "center";
            const textY = labelBelow ? py + 25 : py - 15;
            ctx.fillText(label, px, textY);
        };

        const pXVal = parseFloat(val);
        drawMarker(pXVal, '#e74c3c', "é¢„æœŸä½ç½®", false);

        if(this.baroState === 'revealed') {
            // åœ¨æ­æ™“çŠ¶æ€ï¼Œæ˜¾ç¤ºå­˜å‚¨çš„çœŸå®åˆ†æ•°
            drawMarker(this.actualScore, '#3498db', "å®é™…ä½ç½®", true);
        }
        
        if (this.baroState === 'guessing') {
            const btn = document.getElementById('btn-baro-confirm');
            if (btn) {
                btn.disabled = false;           // è§£é™¤ç¦ç”¨çŠ¶æ€
                btn.style.opacity = "1";        // æ¢å¤ä¸é€æ˜åº¦
                btn.style.cursor = "pointer";   // æ¢å¤æ‰‹å‹æŒ‡é’ˆ
            }
        }
        
        const pct = (this.currentRawScores.filter(s => s < val).length / this.currentRawScores.length * 100).toFixed(1);
        document.getElementById('baro-percentile').innerText = pct + '%';
        this.currentBaroVal = val; this.currentBaroPct = pct;
    }

    calculateActualScore() {
        // è®¡ç®—å½“å‰ Scale çš„å¹³å‡åˆ†
        const scores = this.results.filter(r => r.scale_name === this.currentScaleName).map(r => r.personal_score);
        return scores.length ? scores.reduce((a, b) => a + b, 0) / scores.length : 0;
    }

    handleBarometerConfirmation() {
        if(this.baroState === 'guessing') {
            this.baroState = 'revealed';

            const instruction = document.getElementById('baro-instruction');
            if(instruction) instruction.classList.add('hidden');
            
            // ================= æ ¸å¿ƒä¿®æ”¹ï¼šçœŸå®åé¦ˆé€»è¾‘ =================
            
            // 1. è®¡ç®—ç”¨æˆ·çœŸå®å¾—åˆ†
            const actualScore = this.calculateActualScore();
            this.actualScore = actualScore; // å­˜å…¥å®ä¾‹å˜é‡ä¾›ç»˜å›¾ä½¿ç”¨
            
            // 2. è®¡ç®—çœŸå®ç™¾åˆ†ä½
            const total = this.currentRawScores.length;
            const countLower = this.currentRawScores.filter(s => s < actualScore).length;
            let actualPct = ((countLower / total) * 100).toFixed(1);
            // è¾¹ç•Œå¤„ç†ï¼Œé¿å…å‡ºç°0%æˆ–100%å¯¼è‡´è¯¯è§£
            actualPct = Math.max(0.1, Math.min(99.9, actualPct)).toFixed(1);

            // 3. æ¯”è¾ƒå·®å¼‚
            const predictedPct = parseFloat(this.currentBaroPct).toFixed(1);
            const diff = Math.abs(parseFloat(predictedPct) - parseFloat(actualPct)).toFixed(1);

            // 4. æ›´æ–°UIæ•°æ®
            document.getElementById('predicted-pct').innerText = predictedPct + '%';
            document.getElementById('actual-pct').innerText = actualPct + '%';
            document.getElementById('pct-diff-value').innerText = "Â±" + diff + "%";
            
            // 5. ç”ŸæˆåŸºäºçœŸå®å·®å¼‚çš„è¯„ä»·æ–‡æœ¬
            let evalTxt = "";
            const thresholdGood =  2.5;
            const thresholdFair =  5;

            if (parseFloat(diff) <= thresholdGood) {
                evalTxt = " <b style='color:#27ae60;'>æ‚¨çš„è‡ªæˆ‘è®¤çŸ¥éå¸¸å‡†ç¡®ï¼</b> å®é™…æ•°æ®ä¸æ‚¨çš„é¢„æµ‹é«˜åº¦ä¸€è‡´ã€‚";
            } else if (parseFloat(diff) <= thresholdFair) {
                evalTxt = " <b style='color:#f39c12;'>æ‚¨çš„è‡ªæˆ‘è®¤çŸ¥æ¯”è¾ƒå‡†ç¡®ã€‚</b> å­˜åœ¨å°å¹…åå·®ã€‚";
            } else {
                evalTxt = " <b style='color:#e74c3c;'>æ‚¨çš„è‡ªæˆ‘è®¤çŸ¥å­˜åœ¨æ˜¾è‘—åå·®ã€‚</b> å®é™…æƒ…å†µä¸æ‚¨çš„ç›´è§‰æœ‰æ‰€ä¸åŒã€‚";
            }
            
            document.getElementById('position-diff-text').innerHTML = evalTxt;
            
            // =======================================================

            document.getElementById('baro-slider-area').classList.add('hidden');
            document.getElementById('baro-truth-feedback').classList.remove('hidden');
            document.getElementById('btn-baro-confirm').innerText = "ç»§ç»­";
            
            // åˆ·æ–°ç»˜å›¾ï¼Œä¼ å…¥å½“å‰çš„æ»‘å—ä½ç½®ï¼Œä½†å†…éƒ¨ä¼šå› ä¸º state='revealed' è€Œç»˜åˆ¶ actualScore
            this.updateBarometer(this.currentBaroVal);
        } else {
            // æäº¤Barometeræ•°æ®è®°å½•
            this.results.forEach(r => { 
                if(r.scale_name === this.currentScaleName) { 
                    r.self_marked_pos = this.currentBaroVal; 
                    r.self_marked_percentile = this.currentBaroPct; 
                    // ä¹Ÿå¯ä»¥é€‰æ‹©è®°å½•çœŸå®åˆ†ä½ï¼Œæ–¹ä¾¿åå°åˆ†æ
                    r.actual_score = this.actualScore;
                } 
            });
            this.submitSurvey();
        }
    }

    async submitSurvey() {
        // --- 1. ä¿å­˜åˆ°æœ¬åœ°å…¨é‡ä»“åº“ ---
        try {
            let allData = JSON.parse(localStorage.getItem('all_exp_data') || '{}');
            const topicName = "{{ topic_category }}"; 
            
            if (!allData.topics_data) allData.topics_data = {};
            if (!allData.topics_data[topicName]) allData.topics_data[topicName] = {};

            if (!allData.topics_data[topicName].pre_survey) {
                allData.topics_data[topicName].pre_survey = this.results;
                console.log(`å·²ç¼“å­˜ ${topicName} çš„å‰æµ‹æ•°æ®`);
            } else {
                allData.topics_data[topicName].post_survey = this.results;
                console.log(`å·²ç¼“å­˜ ${topicName} çš„åæµ‹æ•°æ®`);
            }
            localStorage.setItem('all_exp_data', JSON.stringify(allData));
        } catch (e) {
            console.error("æœ¬åœ°ç¼“å­˜ä¿å­˜å¤±è´¥:", e);
        }

        // --- 2. æäº¤åç«¯å¹¶è·³è½¬ ---
        fetch('/api/survey/submit', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({results: this.results})
        })
        .then(response => {
            // å¦‚æœåç«¯æŠ¥ 500ï¼Œresponse.ok ä¸º false
            if (!response.ok) {
                console.warn("åç«¯ 500 é”™è¯¯ï¼Œæ‰§è¡Œå¼ºåˆ¶è·³è½¬æ–¹æ¡ˆ");
                window.location.href = '/experiment'; // å¼ºè¡Œè·³è½¬
                return;
            }
            return response.json();
        })
        .then(data => {
            if (data && data.success) {
                window.location.href = data.redirect || '/experiment';
            }
        })
        .catch(err => {
            // ç½‘ç»œæ–­äº†æˆ–å…¶å®ƒå¼‚å¸¸
            console.error("æäº¤å¼‚å¸¸:", err);
            window.location.href = '/experiment';
        });
    } // è¿™é‡Œå…³é—­ submitSurvey å‡½æ•°

} // 

// ä»¥ä¸‹æ˜¯å®ä¾‹åŒ–ä»£ç ï¼Œå¿…é¡»åœ¨ç±»é—­åˆä¹‹å
const exp = new Experiment(DATA_LIB);
exp.start();
</script>
</body>
</html>
