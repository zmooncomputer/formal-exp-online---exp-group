{% extends "layout.html" %}

{% block content %}
    <span class="icon-large" style="color: #27ae60;">✅</span>
    <h1 id="status-title">正在同步实验数据...</h1>
    
    <p id="status-desc">请稍候，系统正在确保您的数据安全上传。完成前请勿关闭窗口。</p>
    
    <div id="status-icon" style="margin: 40px 0; padding: 15px; background-color: #fff9db; color: #f59f00; border-radius: 6px; display: inline-block;">
        <span style="font-weight: bold;">数据上传中...</span>
    </div>

    <p style="font-size: 0.9em; color: #95a5a6; margin-top: 30px;">
        如有疑问，请联系实验负责人。
    </p>
    
    <a href="/api/download" id="download-btn" class="btn" style="background: #95a5a6; display: none;">手动备份数据</a>
{% endblock %}

{% block extra_js %}
<script>
async function submitToFormspark() {
    // 【修复点 1】确保使用英文引号
    const FORMSPARK_ACTION_URL = "https://submit-form.com/dzhHi1fJ7"; 
    
    const statusTitle = document.getElementById('status-title');
    const statusDesc = document.getElementById('status-desc');
    const statusIcon = document.getElementById('status-icon');
    const downloadBtn = document.getElementById('download-btn');

    // 1. 获取本地数据
    let rawData = {};
    try {
        const storedData = localStorage.getItem('all_exp_data');
        // 【修复点 2】增加解析容错，防止 null 或异常格式导致崩溃
        rawData = storedData ? JSON.parse(storedData) : {};
    } catch (e) {
        console.error("本地数据解析失败:", e);
    }

    if (Object.keys(rawData).length === 0) {
        if(statusTitle) statusTitle.innerText = "未找到本地数据";
        if(statusIcon) statusIcon.innerHTML = "<b>提示：</b> 可能是数据已提交或缓存被清理。";
        return;
    }

    // 2. 数据处理
    const payload = {
        participant_id: rawData.participant_id || "未知用户",
        start_time: rawData.start_time,
        end_time: new Date().toLocaleString(),
    };

    if (rawData.topics_data) {
        Object.keys(rawData.topics_data).forEach(topic => {
            const data = rawData.topics_data[topic];
            // 确保数据存在再执行 stringify
            payload[`${topic}_前测`] = data.pre_survey ? JSON.stringify(data.pre_survey) : "";
            payload[`${topic}_对话记录`] = data.chat_history || "";
            payload[`${topic}_后测`] = data.post_survey ? JSON.stringify(data.post_survey) : "";
        });
    }

    try {
        const response = await fetch(FORMSPARK_ACTION_URL, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Accept": "application/json",
            },
            body: JSON.stringify(payload),
        });

        if (response.ok) {
            // 3. 成功后的界面反馈
            if(statusTitle) statusTitle.innerText = "实验圆满结束";
            if(statusDesc) statusDesc.innerText = "非常感谢您的配合！您的数据已成功同步至云端。";
            if(statusIcon) {
                statusIcon.style.backgroundColor = "#f0fdf4";
                statusIcon.style.color = "#27ae60";
                statusIcon.innerHTML = "<b>数据已自动保存</b>";
            }
            
            // 成功后才清除本地缓存
            localStorage.removeItem('all_exp_data');
        } else {
            throw new Error("Formspark 响应异常，状态码: " + response.status);
        }
    } catch (error) {
        console.error("提交失败:", error);
        if(statusTitle) statusTitle.innerText = "数据同步遇到异常";
        if(statusDesc) statusDesc.innerText = "请点击下方按钮手动下载数据并发送给负责人。";
        if(statusIcon) {
            statusIcon.style.backgroundColor = "#fff5f5";
            statusIcon.style.color = "#fa5252";
            statusIcon.innerHTML = "<b>上传失败</b>";
        }
        if(downloadBtn) downloadBtn.style.display = "inline-block";
    }
}

window.onload = submitToFormspark;
</script>
{% endblock %}
